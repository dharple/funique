#!/usr/bin/php
<?php
/**
 * Given two directories, find what files are unique to one or the other
 * directory.
 *
 * Used to see what files have been removed (as opposed to simply being moved)
 * between two backups.
 *
 * Compares file contents.
 */

ini_set('memory_limit', '1G');

require_once dirname(__DIR__) . '/vendor/autoload.php';

if ($argc < 3 || !is_dir($argv[1]) || !is_dir($argv[2])) {
	fprintf(STDERR, "Usage:\n\t" . basename($argv[0]) . " DIR DIR\n");
	exit(-1);
}

$dirs = [
	new \Funique\Directory($argv[1]),
	new \Funique\Directory($argv[2])
];

$files = [];
$sizeGroups = [];

foreach ($dirs as $which => $dir) {
	$files[$which] = $dir->getAllFiles();
	$sizeGroups = array_merge($sizeGroups, array_keys($files[$which]));
}

$sizeGroups = array_unique($sizeGroups, SORT_NUMERIC);

foreach ($sizeGroups as $sizeGroup) {
	if (array_key_exists($sizeGroup, $files[0]) && !array_key_exists($sizeGroup, $files[1])) {
		foreach ($files[0][$sizeGroup] as $file) {
			print($file->getPath() . "\n");
		}
		continue;
	}

	if (array_key_exists($sizeGroup, $files[1]) && !array_key_exists($sizeGroup, $files[0])) {
		foreach ($files[1][$sizeGroup] as $file) {
			print($file->getPath() . "\n");
		}
		continue;
	}

	$filesA = $files[0][$sizeGroup];
	$filesB = $files[1][$sizeGroup];

	foreach ($filesA as $offsetA => $fileA) {
		$sizeMatch = false;

		foreach ($filesB as $fileB) {
			if ($fileA->getSize() == $fileB->getSize()) {
				if ($fileA->getSum() == $fileB->getSum()) {
					$fileA->isUnique(false);
					$fileB->isUnique(false);
				}

				$sizeMatch = true;
				break;
			}
		}

		if (!$sizeMatch) {
			print($fileA->getPath() . "\n");
			unset($filesA[$offsetA]);
		}
	}

	foreach ($filesB as $offsetB => $fileB) {
		$sizeMatch = false;

		foreach ($filesA as $fileA) {
			if ($fileB->getSize() == $fileA->getSize()) {
				if ($fileA->getSum() == $fileB->getSum()) {
					$fileA->isUnique(false);
					$fileB->isUnique(false);

//					print("DUPE: " . $fileA->getPath() . " === " . $fileB->getPath() . "\n");
				}

				$sizeMatch = true;
				break;
			}
		}

		if (!$sizeMatch) {
			print($fileB->getPath() . "\n");
			unset($filesB[$offsetB]);
		}
	}

	if (empty($filesA) && empty($filesB)) {
		continue;
	}

	foreach ($filesA as $fileA) {
		if ($fileA->isUnique()) {
			print($fileA->getPath() . "\n");
		}
	}

	foreach ($filesB as $fileB) {
		if ($fileB->isUnique()) {
			print($fileB->getPath() . "\n");
		}
	}

}

// vim: ai:cin
